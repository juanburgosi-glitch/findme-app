<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title data-translate-key="register-title">FindMe - Crear Cuenta</title>
    
    <link rel="icon" type="image/png" href="public/images/favicon.png" />
    <link href="public/css/styles.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    
    <script src="public/js/translator.js"></script>
</head>
<body class="bg-background-dark font-display text-gray-300">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-8 m-4 border border-border-dark">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white" data-translate-key="create-account-header">Crea tu cuenta</h1>
                <p class="mt-2 text-sm text-gray-400" data-translate-key="create-account-prompt">Únete a FindMe para compartir información médica y tu ubicación en emergencias.</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="email" data-translate-key="email-label">Dirección de correo</label>
                    <div class="mt-1">
                        <input autocomplete="email" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="email" name="email" data-translate-key="email-placeholder" data-translate-property="placeholder" required type="email" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="password" data-translate-key="password-label">Contraseña</label>
                    <div class="mt-1">
                        <input autocomplete="new-password" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="password" name="password" data-translate-key="password-placeholder" data-translate-property="placeholder" required type="password" />
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row-reverse gap-4 pt-4">
                    <button id="submit-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary hover:bg-primary/90" type="submit" data-translate-key="confirm">
                        Confirmar
                    </button>
                    <a href="index.html" class="w-full inline-flex justify-center py-3 px-4 border border-border-dark shadow-sm text-sm font-medium rounded-lg text-gray-300 bg-card-dark hover:bg-border-dark" data-translate-key="cancel">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div id="verification-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-8 m-4 border border-border-dark">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-white mb-4" data-translate-key="verification-title">Verificación de correo</h2>
                <p class="text-gray-400 mb-6" data-translate-key="verification-message">Hemos enviado un código de verificación a tu correo electrónico.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2" for="verification-code" data-translate-key="verification-code-label">Código de verificación</label>
                    <input class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="verification-code" type="text" maxlength="6" pattern="\d{6}" placeholder="Ingresa el código de 6 dígitos" required />
                </div>
                <div class="flex flex-col gap-3">
                    <button id="verify-btn" class="w-full py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary hover:bg-primary/90" data-translate-key="send-verification">
                        Enviar confirmación
                    </button>
                    <button id="resend-btn" class="text-primary hover:text-primary/80 text-sm" data-translate-key="resend-code">
                        Reenviar código
                    </button>
                    <button id="cancel-verify-btn" class="text-gray-400 hover:text-gray-300 text-sm" type="button" data-translate-key="cancel">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('register-form');
            const verificationOverlay = document.getElementById('verification-overlay');
            const verifyBtn = document.getElementById('verify-btn');
            const resendBtn = document.getElementById('resend-btn');
            const cancelVerifyBtn = document.getElementById('cancel-verify-btn'); // Nuevo botón de cancelar
            
            // URL de tu Backend
            const API_URL = 'https://findme-app-backend.onrender.com';
            
            // Variables para almacenar temporalmente el email y la contraseña
            let tempEmail = '';
            let tempPassword = '';

            // Función robusta para manejar la respuesta de la API y errores
            async function makeAPIRequest(url, options) {
                try {
                    const response = await fetch(url, options);
                    const contentType = response.headers.get('content-type');
                    
                    // Intenta siempre leer el cuerpo (body), asumiendo JSON si es posible
                    const isJson = contentType && contentType.includes('application/json');
                    const data = isJson ? await response.json() : await response.text();

                    if (!response.ok) {
                        // Si hay un error, busca el mensaje en el objeto JSON o usa el texto
                        const errorMessage = isJson && data.error 
                            ? data.error 
                            : typeof data === 'string' && data.length > 0 
                            ? data 
                            : `Error de conexión con el servidor (Status: ${response.status})`;
                        
                        throw new Error(errorMessage);
                    }

                    return { response, data };
                } catch (error) {
                    console.error('Error detallado:', error);
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error('No se puede conectar al servidor. Verifica tu conexión a internet.');
                    }
                    throw error;
                }
            }

            // =======================================================
            // 1. EVENTO SUBMIT (Solicitar Código de Verificación)
            // =======================================================
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    // Paso 1: Llamar al endpoint para solicitar el código
                    await makeAPIRequest(`${API_URL}/api/register/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });

                    // Si la solicitud es exitosa:
                    tempEmail = email;
                    tempPassword = password;
                    document.getElementById('verification-code').value = ''; // Limpiar campo
                    verificationOverlay.classList.remove('hidden'); // Mostrar el modal
                } catch (error) {
                    alert(error.message);
                }
            });

            // =======================================================
            // 2. EVENTO VERIFY (Registro Final)
            // =======================================================
            verifyBtn.addEventListener('click', async () => {
                const verificationCode = document.getElementById('verification-code').value;
                if (!verificationCode || verificationCode.length !== 6) {
                    alert('Por favor, ingresa el código de 6 dígitos');
                    return;
                }

                try {
                    // Paso 2: Registro FINAL con credenciales y código
                    await makeAPIRequest(`${API_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: tempEmail, 
                            password: tempPassword, 
                            verificationCode 
                        })
                    });

                    alert('¡Usuario registrado con éxito! Ahora puedes iniciar sesión.');
                    
                    // Limpiar variables temporales y redirigir
                    tempEmail = '';
                    tempPassword = '';
                    window.location.href = 'index.html';
                } catch (error) {
                    alert(error.message);
                }
            });

            // =======================================================
            // 3. EVENTO RESEND (Reenviar Código)
            // =======================================================
            resendBtn.addEventListener('click', async () => {
                if (!tempEmail) {
                    alert('Error: No hay correo electrónico para reenviar el código');
                    return;
                }

                try {
                    // Reenvío de código, usando el mismo endpoint que el primer paso
                    await makeAPIRequest(`${API_URL}/api/register/verify`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: tempEmail })
                    });

                    alert('Se ha enviado un nuevo código de verificación.');
                } catch (error) {
                    alert(error.message);
                }
            });

            // =======================================================
            // 4. MANEJO DE UX (Enter y Escape)
            // =======================================================
            
            // Botón de Cancelar en el Overlay
            cancelVerifyBtn.addEventListener('click', () => {
                verificationOverlay.classList.add('hidden');
                // Opcional: limpiar credenciales temporales si se cancela
                // tempEmail = '';
                // tempPassword = '';
            });

            // Prevenir el envío del formulario principal al presionar Enter en el código
            document.getElementById('verification-code').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    verifyBtn.click();
                }
            });
            
            // CERRAR OVERLAY AL PRESIONAR ESC (Mejora de UX)
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && !verificationOverlay.classList.contains('hidden')) {
                    verificationOverlay.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>