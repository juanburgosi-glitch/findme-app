<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title data-translate-key="register-title">FindMe - Crear Cuenta</title>
    
    <link rel="icon" type="image/png" href="public/images/favicon.png" />
    <link href="public/css/styles.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    
    <script src="public/js/translator.js"></script>
</head>
<body class="bg-background-dark font-display text-gray-300">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-8 m-4 border border-border-dark">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white" data-translate-key="create-account-header">Crea tu cuenta</h1>
                <p class="mt-2 text-sm text-gray-400" data-translate-key="create-account-prompt">Únete a FindMe para compartir información médica y tu ubicación en emergencias.</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="email" data-translate-key="email-label">Dirección de correo</label>
                    <div class="mt-1">
                        <input autocomplete="email" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="email" name="email" data-translate-key="email-placeholder" data-translate-property="placeholder" required type="email" />
                    </div>
                </div>
                <div id="verification-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-400" for="verification-code" data-translate-key="verification-code-label">Código de verificación</label>
                    <div class="mt-1">
                        <input class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="verification-code" name="verification-code" data-translate-key="verification-code-placeholder" data-translate-property="placeholder" placeholder="Ingresa el código de 6 dígitos" maxlength="6" required type="text" pattern="\d{6}" />
                    </div>
                    <p class="mt-2 text-sm text-gray-400" data-translate-key="verification-help">Se ha enviado un código de verificación a tu correo electrónico</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="password" data-translate-key="password-label">Contraseña</label>
                    <div class="mt-1">
                        <input autocomplete="new-password" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="password" name="password" data-translate-key="password-placeholder" data-translate-property="placeholder" required type="password" />
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row-reverse gap-4 pt-4">
                    <button id="submit-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary hover:bg-primary/90" type="submit" data-translate-key="send-verification">
                        Enviar código de verificación
                    </button>
                    <a href="index.html" class="w-full inline-flex justify-center py-3 px-4 border border-border-dark shadow-sm text-sm font-medium rounded-lg text-gray-300 bg-card-dark hover:bg-border-dark" data-translate-key="cancel">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('register-form');
            const verificationSection = document.getElementById('verification-section');
            const submitBtn = document.getElementById('submit-btn');
            const API_URL = 'https://findme-app-backend.onrender.com';
            let isVerificationStep = false;
            let tempEmail = '';
            
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const verificationCode = document.getElementById('verification-code').value;

                try {
                    if (!isVerificationStep) {
                        // Primer paso: Solicitar código de verificación
                        const response = await fetch(`${API_URL}/api/request-verification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            isVerificationStep = true;
                            tempEmail = email;
                            verificationSection.classList.remove('hidden');
                            submitBtn.textContent = 'Crear Cuenta';
                            submitBtn.dataset.translateKey = 'create-account-button';
                            // Deshabilitar campos de email y contraseña
                            document.getElementById('email').readOnly = true;
                            document.getElementById('email').classList.add('cursor-not-allowed', 'opacity-75');
                        } else {
                            alert(`Error: ${data.error || 'Ocurrió un error al enviar el código.'}`);
                        }
                    } else {
                        // Segundo paso: Verificar código y crear cuenta
                        const response = await fetch(`${API_URL}/api/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: tempEmail, 
                                password, 
                                verificationCode 
                            })
                        });
                        const data = await response.json();

                        if (response.ok) {
                            alert('¡Usuario registrado con éxito! Ahora puedes iniciar sesión.');
                            window.location.href = 'index.html';
                        } else {
                            alert(`Error: ${data.error || 'Código de verificación inválido.'}`);
                        }
                    }
                } catch (error) {
                    console.error('Error de red:', error);
                    alert('No se pudo conectar con el servidor. Inténtalo de nuevo más tarde.');
                }
            });
        });
    </script>
</body>
</html>