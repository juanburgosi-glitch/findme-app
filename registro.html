<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title data-translate-key="register-title">FindMe - Crear Cuenta</title>
    
    <link rel="icon" type="image/png" href="public/images/favicon.png" />
    <link href="public/css/styles.css" rel="stylesheet" />
    
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
    
    <script src="public/js/translator.js"></script>
</head>
<body class="bg-background-dark font-display text-gray-300">
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-8 m-4 border border-border-dark">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white" data-translate-key="create-account-header">Crea tu cuenta</h1>
                <p class="mt-2 text-sm text-gray-400" data-translate-key="create-account-prompt">Únete a FindMe para compartir información médica y tu ubicación en emergencias.</p>
            </div>
            <form id="register-form" class="mt-8 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="email" data-translate-key="email-label">Dirección de correo</label>
                    <div class="mt-1">
                        <input autocomplete="email" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="email" name="email" data-translate-key="email-placeholder" data-translate-property="placeholder" required type="email" />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400" for="password" data-translate-key="password-label">Contraseña</label>
                    <div class="mt-1">
                        <input autocomplete="new-password" class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="password" name="password" data-translate-key="password-placeholder" data-translate-property="placeholder" required type="password" />
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row-reverse gap-4 pt-4">
                    <button id="submit-btn" class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary hover:bg-primary/90" type="submit" data-translate-key="confirm">
                        Confirmar
                    </button>
                    <a href="index.html" class="w-full inline-flex justify-center py-3 px-4 border border-border-dark shadow-sm text-sm font-medium rounded-lg text-gray-300 bg-card-dark hover:bg-border-dark" data-translate-key="cancel">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Verification overlay -->
    <div id="verification-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <div class="bg-card-dark rounded-xl shadow-2xl w-full max-w-md p-8 m-4 border border-border-dark">
            <div class="text-center">
                <h2 class="text-2xl font-bold text-white mb-4" data-translate-key="verification-title">Verificación de correo</h2>
                <p class="text-gray-400 mb-6" data-translate-key="verification-message">Hemos enviado un código de verificación a tu correo electrónico.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-400 mb-2" for="verification-code" data-translate-key="verification-code-label">Código de verificación</label>
                    <input class="w-full px-4 py-3 rounded-lg bg-background-dark border-border-dark text-white focus:outline-none focus:ring-2 focus:ring-primary" id="verification-code" type="text" maxlength="6" pattern="\d{6}" placeholder="Ingresa el código de 6 dígitos" required />
                </div>
                <div class="flex flex-col gap-3">
                    <button id="verify-btn" class="w-full py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-primary hover:bg-primary/90" data-translate-key="send-verification">
                        Enviar confirmación
                    </button>
                    <button id="resend-btn" class="text-primary hover:text-primary/80 text-sm" data-translate-key="resend-code">
                        Reenviar código
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('register-form');
            const verificationOverlay = document.getElementById('verification-overlay');
            const verifyBtn = document.getElementById('verify-btn');
            const resendBtn = document.getElementById('resend-btn');
            const API_URL = 'https://findme-app-backend.onrender.com';

            async function makeAPIRequest(url, options) {
                try {
                    const response = await fetch(url, options);
                    
                    // Log para depuración
                    console.log('API Response:', {
                        status: response.status,
                        url: response.url,
                        headers: Object.fromEntries(response.headers)
                    });

                    if (response.status === 404) {
                        throw new Error('El servicio de verificación no está disponible temporalmente');
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.error('Tipo de contenido no válido:', contentType);
                        throw new Error('Respuesta del servidor no válida');
                    }

                    const data = await response.json();
                    return { response, data };
                } catch (error) {
                    console.error('Error detallado:', error);
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error('No se puede conectar al servidor. Verifica tu conexión a internet.');
                    }
                    throw error;
                }
            }

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    // Intentar registrar directamente sin verificación por ahora
                    const { response, data } = await makeAPIRequest(`${API_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    if (response.ok) {
                        alert('¡Usuario registrado con éxito! Ahora puedes iniciar sesión.');
                        window.location.href = 'index.html';
                    } else {
                        throw new Error(data.error || 'Error en el registro');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });

            verifyBtn.addEventListener('click', async () => {
                const verificationCode = document.getElementById('verification-code').value;
                try {
                    const { response, data } = await makeAPIRequest(`${API_URL}/api/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: tempEmail, 
                            password: tempPassword, 
                            verificationCode 
                        })
                    });

                    if (response.ok) {
                        alert('¡Usuario registrado con éxito! Ahora puedes iniciar sesión.');
                        window.location.href = 'index.html';
                    } else {
                        throw new Error(data.error || 'Código de verificación inválido');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });

            resendBtn.addEventListener('click', async () => {
                try {
                    const { response, data } = await makeAPIRequest(`${API_URL}/api/request-verification`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: tempEmail })
                    });

                    if (response.ok) {
                        alert('Se ha enviado un nuevo código de verificación.');
                    } else {
                        throw new Error(data.error || 'No se pudo reenviar el código');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });
        });
    </script>
</body>
</html>