<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title id="page-title">FindMe - Ficha Médica</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20; }
    </style>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { 
                        "primary": "#13a4ec", 
                        "background-dark": "#101c22", 
                        "card-dark": "#1a2831",
                        "border-dark": "#2a3c47"
                    },
                    fontFamily: { "display": ["Inter"] },
                },
            },
        }
    </script>
</head>
<body class="bg-background-dark font-display text-gray-200">
    <div class="flex flex-col min-h-screen pt-16"> <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                    <div>
                        <a href="dashboard.html" class="flex items-center gap-2 text-sm font-medium text-gray-400 hover:text-primary transition-colors mb-4">
                            <span class="material-symbols-outlined">arrow_back</span>
                            <span>Volver al listado</span>
                        </a>
                        <h2 class="text-3xl font-bold text-white">Ficha Médica</h2>
                        <p id="profile-description" class="mt-1 text-gray-400">Cargando información...</p>
                    </div>
                </div>
                <div id="profile-card" class="bg-card-dark rounded-xl shadow-lg overflow-hidden hidden">
                    </div> <div id="anchor-button-container" class="mt-8"></div>
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">Información Personal</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                             <div class="border-t border-gray-700 pt-4 sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <p class="text-sm font-medium text-gray-400">Nombre Completo</p>
                                <p id="full-name" class="sm:col-span-2 text-sm text-gray-200">-</p>
                                <input id="input-full-name" type="text" class="hidden sm:col-span-2 text-sm rounded-lg border-gray-600 bg-gray-800 text-gray-200 focus:ring-primary focus:border-primary" required>
                            </div>
                            <div class="border-t border-gray-700 pt-4 sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <p class="text-sm font-medium text-gray-400">Teléfono de Contacto</p>
                                <p id="contact-number" class="sm:col-span-2 text-sm text-gray-200">-</p>
                                <input id="input-contact-number" type="tel" class="hidden sm:col-span-2 text-sm rounded-lg border-gray-600 bg-gray-800 text-gray-200 focus:ring-primary focus:border-primary">
                            </div>
                            <div class="border-t border-gray-700 pt-4 sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <p class="text-sm font-medium text-gray-400">Hospital</p>
                                <p id="preferred-hospital" class="sm:col-span-2 text-sm text-gray-200">-</p>
                                <input id="input-preferred-hospital" type="text" class="hidden sm:col-span-2 text-sm rounded-lg border-gray-600 bg-gray-800 text-gray-200 focus:ring-primary focus:border-primary">
                            </div>
                            <div class="border-t border-gray-700 pt-4 sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-2">
                                <p class="text-sm font-medium text-gray-400">Condiciones Médicas</p>
                                <p id="medical-conditions" class="sm:col-span-2 text-sm text-gray-200">-</p>
                                <textarea id="input-medical-conditions" rows="3" class="hidden sm:col-span-2 text-sm rounded-lg border-gray-600 bg-gray-800 text-gray-200 focus:ring-primary focus:border-primary"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-700">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-white">Ubicación en Tiempo Real</h3>
                            <button id="reload-location-btn" class="flex items-center gap-2 px-3 py-1 rounded-lg bg-primary/20 text-primary hover:bg-primary/30 transition-colors text-sm font-medium disabled:opacity-50 disabled:cursor-wait">
                                <span class="material-symbols-outlined">my_location</span>
                                <span>Actualizar</span>
                            </button>
                        </div>
                        <div id="map" class="w-full h-80 rounded-lg bg-gray-700 border border-gray-600 flex items-center justify-center">
                             <p class="text-gray-400">Esperando ubicación...</p>
                        </div>
                        <p id="location-status" class="text-sm text-center text-gray-400 mt-3">Solicitando permiso de ubicación...</p>
                    </div>
                    <div class="bg-background-dark/80 px-6 py-4 flex justify-end gap-4">
                        <button id="edit-btn" class="px-6 py-2.5 rounded-lg bg-primary text-white text-sm font-semibold shadow-lg hover:bg-primary/90 transition-all">Editar Ficha</button>
                        <button id="cancel-btn" class="hidden px-6 py-2.5 rounded-lg bg-gray-600 text-white text-sm font-semibold hover:bg-gray-500 transition-all">Cancelar</button>
                        <button id="save-btn" class="hidden px-6 py-2.5 rounded-lg bg-green-600 text-white text-sm font-semibold shadow-lg hover:bg-green-500 transition-all">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let map;
            let marker;
            
            const elements = {
                title: document.getElementById('page-title'),
                description: document.getElementById('profile-description'),
                card: document.getElementById('profile-card'),
                fullName: document.getElementById('full-name'),
                contactNumber: document.getElementById('contact-number'),
                preferredHospital: document.getElementById('preferred-hospital'),
                medicalConditions: document.getElementById('medical-conditions'),
                inputFullName: document.getElementById('input-full-name'),
                inputContactNumber: document.getElementById('input-contact-number'),
                inputPreferredHospital: document.getElementById('input-preferred-hospital'),
                inputMedicalConditions: document.getElementById('input-medical-conditions'),
                editBtn: document.getElementById('edit-btn'),
                saveBtn: document.getElementById('save-btn'),
                cancelBtn: document.getElementById('cancel-btn'),
                locationStatus: document.getElementById('location-status'),
                mapContainer: document.getElementById('map'),
                reloadLocationBtn: document.getElementById('reload-location-btn'),
                anchorButtonContainer: document.getElementById('anchor-button-container'),
            };

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Debes iniciar sesión para ver esta página.');
                window.location.href = 'index.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const personId = params.get('id');
            if (!personId) {
                alert('No se especificó una persona.');
                window.location.href = 'dashboard.html';
                return;
            }

            // --- Lógica de PWA y Service Worker ---
            async function registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    try {
                        const permission = await Notification.requestPermission();
                        if (permission !== 'granted') {
                            throw new Error('Permiso de notificaciones denegado.');
                        }
                        
                        const registration = await navigator.serviceWorker.register('/service-worker.js');
                        console.log('Service Worker registrado con éxito:', registration);

                        // Esperar a que el Service Worker esté activo para enviarle un mensaje
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'START_TRACKING',
                                payload: {
                                    personId: personId,
                                    token: token
                                }
                            });
                        }
                        
                        alert('¡Dispositivo anclado! La ubicación se comenzará a enviar en segundo plano.');
                        document.getElementById('anchor-btn').style.display = 'none';

                    } catch (error) {
                        console.error('Error en el proceso de anclaje:', error);
                        alert(`No se pudo anclar el dispositivo: ${error.message}`);
                    }
                } else {
                    alert('Tu navegador no soporta la funcionalidad en segundo plano.');
                }
            }

            // Crear y añadir el botón de "Anclar Dispositivo"
            const anchorBtn = document.createElement('button');
            anchorBtn.id = 'anchor-btn';
            anchorBtn.className = 'w-full px-6 py-3 rounded-lg bg-green-600 text-white font-semibold shadow-lg hover:bg-green-700 transition-all flex items-center justify-center gap-2';
            anchorBtn.innerHTML = `<span class="material-symbols-outlined">gps_fixed</span> Anclar este Dispositivo para seguimiento`;
            anchorBtn.onclick = registerServiceWorker;
            elements.anchorButtonContainer.appendChild(anchorBtn);

            // --- Lógica de la página ---
            try {
                const response = await fetch(`/api/people/${personId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('No se pudo cargar la información de la persona.');
                const person = await response.json();
                populateFields(person);
                elements.card.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                elements.description.textContent = 'Error: ' + error.message;
            }

            function populateFields(person) {
                elements.title.textContent = `Ficha Médica de ${person.full_name}`;
                elements.description.textContent = `Vista detallada de la información médica de ${person.full_name}.`;
                elements.fullName.textContent = person.full_name || '-';
                elements.contactNumber.textContent = person.contact_number || '-';
                elements.preferredHospital.textContent = person.preferred_hospital || '-';
                elements.medicalConditions.textContent = person.medical_conditions || '-';
            }

            function toggleEditMode(isEditing) {
                document.querySelectorAll('.grid p[id]').forEach(p => p.classList.toggle('hidden', isEditing));
                document.querySelectorAll('.grid input, .grid textarea').forEach(input => input.classList.toggle('hidden', !isEditing));
                elements.editBtn.classList.toggle('hidden', isEditing);
                elements.saveBtn.classList.toggle('hidden', !isEditing);
                elements.cancelBtn.classList.toggle('hidden', !isEditing);
            }

            elements.editBtn.addEventListener('click', () => {
                elements.inputFullName.value = elements.fullName.textContent;
                elements.inputContactNumber.value = elements.contactNumber.textContent;
                elements.inputPreferredHospital.value = elements.preferredHospital.textContent;
                elements.inputMedicalConditions.value = elements.medicalConditions.textContent;
                toggleEditMode(true);
            });

            elements.cancelBtn.addEventListener('click', () => toggleEditMode(false));

            elements.saveBtn.addEventListener('click', async () => {
                const updatedData = {
                    fullName: elements.inputFullName.value,
                    contactNumber: elements.inputContactNumber.value,
                    preferredHospital: elements.inputPreferredHospital.value,
                    medicalConditions: elements.inputMedicalConditions.value
                };
                try {
                    const response = await fetch(`${API_URL}/api/people/${personId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Error del servidor');
                    }
                    const savedPerson = await response.json();
                    populateFields(savedPerson);
                    toggleEditMode(false);
                    alert('¡Información actualizada con éxito!');
                } catch (error) {
                    console.error('Error al guardar:', error);
                    alert(`No se pudo guardar la información: ${error.message}`);
                }
            });

            const geoOptions = { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 };
            function updateMapLocation(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                elements.locationStatus.textContent = `Última actualización: ${new Date().toLocaleTimeString()}`;
                if (!map) {
                    elements.mapContainer.innerHTML = ''; 
                    map = L.map('map').setView([lat, lon], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                    }).addTo(map);
                    marker = L.marker([lat, lon]).addTo(map).bindPopup('<b>Ubicación actual</b>').openPopup();
                } else {
                    const newLatLng = new L.LatLng(lat, lon);
                    marker.setLatLng(newLatLng);
                    map.panTo(newLatLng);
                }
            }
            const handleLocationError = (err) => {
                let message = 'Ocurrió un error desconocido.';
                if (err.code === err.PERMISSION_DENIED) message = 'Permiso de ubicación denegado.';
                if (err.code === err.POSITION_UNAVAILABLE) message = 'La información de ubicación no está disponible.';
                if (err.code === err.TIMEOUT) message = `La solicitud de ubicación ha caducado (${geoOptions.timeout / 1000}s).`;
                elements.locationStatus.textContent = message;
            };
            function forceReloadLocation() {
                elements.locationStatus.textContent = 'Actualizando ubicación...';
                const icon = elements.reloadLocationBtn.querySelector('span');
                elements.reloadLocationBtn.disabled = true;
                icon.classList.add('animate-spin');
                const onFinish = () => {
                    elements.reloadLocationBtn.disabled = false;
                    icon.classList.remove('animate-spin');
                };
                navigator.geolocation.getCurrentPosition(
                    (position) => { updateMapLocation(position); onFinish(); },
                    (err) => { handleLocationError(err); onFinish(); },
                    geoOptions
                );
            }
            function startContinuousTracking() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.watchPosition(updateMapLocation, handleLocationError, geoOptions);
                } else {
                    elements.locationStatus.textContent = 'Geolocalización no es compatible.';
                }
            }
            startContinuousTracking();
            elements.reloadLocationBtn.addEventListener('click', forceReloadLocation);
        });
    </script>
</body>
</html>